<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Mini</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; }
  .card:hover { transform: translateY(-4px); box-shadow:0 4px 15px rgba(0,0,0,.1); transition:.2s; }
  .preview-img { height:150px; object-fit:cover; }
  .price { color:#e53935; font-weight:bold; }
</style>
</head>
<body>

<div class="container mt-4">

  <div id="loginSection" class="card mx-auto" style="max-width:400px;">
    <div class="card-body">
      <h4 class="text-center mb-3">üîê ƒêƒÉng nh·∫≠p</h4>
      <input id="username" class="form-control mb-2" placeholder="T√†i kho·∫£n">
      <input id="password" type="password" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u">
      <button class="btn btn-primary w-100 mb-2" onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <button class="btn btn-secondary w-100" onclick="loginGuest()">V√†o v·ªõi t∆∞ c√°ch kh√°ch</button>
    </div>
  </div>

  <div id="shopSection" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center">
        <h2 class="me-3">üõí Shop Mini</h2>
        <button class="btn btn-success btn-sm" onclick="openCart()">Xem gi·ªè h√†ng</button>
      </div>
      <div>
        <span id="roleLabel" class="me-3 fw-bold text-primary"></span>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div id="addFormSection" class="card mb-4">
      <div class="card-body">
        <h5>Th√™m s·∫£n ph·∫©m</h5>
        <form id="productForm">
          <div class="row g-2">
            <div class="col-md-3"><input id="nameInput" class="form-control" placeholder="T√™n" required></div>
            <div class="col-md-3"><input id="priceInput" type="number" class="form-control" placeholder="Gi√°" required></div>
            <div class="col-md-4"><input id="descInput" class="form-control" placeholder="M√¥ t·∫£" required></div>
            <div class="col-md-2"><input id="imageInput" type="file" class="form-control" accept="image/*" required></div>
          </div>
          <button class="btn btn-success mt-2">Th√™m</button>
        </form>
      </div>
    </div>

    <div class="row g-3" id="productList"></div>
  </div>
</div>

<!-- Modal s·ª≠a -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h5></div>
      <div class="modal-body">
        <input type="number" id="editPrice" class="form-control mb-3" placeholder="Gi√° m·ªõi">
        <input type="file" id="editImage" class="form-control" accept="image/*">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-primary" id="saveEdit">L∆∞u</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal h√≥a ƒë∆°n -->
<div class="modal fade" id="billModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>üßæ H√≥a ƒë∆°n</h5></div>
      <div class="modal-body">
        <h6 id="billName"></h6>
        <p id="billDesc" class="text-muted"></p>
        <strong>T·ªïng ti·ªÅn: <span id="billTotal" class="price"></span></strong>
        <div class="text-center mt-3">
          <p>QR thanh to√°n</p>
          <img id="qrImg" width="200">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal gi·ªè h√†ng -->
<div class="modal fade" id="cartModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>üõí Gi·ªè h√†ng</h5></div>
      <div class="modal-body" id="cartBody"></div>
      <div class="modal-footer">
        <strong class="me-auto">T·ªïng: <span id="cartTotal" class="price"></span></strong>
        <button class="btn btn-primary" onclick="checkoutCart()">Thanh to√°n</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = { /* gi·ªØ nguy√™n config c·ªßa b·∫°n */ };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role=null, products=[], cart=[];
let currentEditIndex=null;

const editModalInstance=new bootstrap.Modal(editModal);
const billModalInstance=new bootstrap.Modal(billModal);
const cartModalInstance=new bootstrap.Modal(cartModal);

window.login=()=>{ if(username.value==="admin"&&password.value==="123"){role="admin";startShop();}else alert("Sai t√†i kho·∫£n!"); }
window.loginGuest=()=>{role="guest";startShop();}
window.logout=()=>location.reload();

function startShop(){
  loginSection.style.display="none";
  shopSection.style.display="block";
  roleLabel.textContent=role==="admin"?"Ch·∫ø ƒë·ªô Ng∆∞·ªùi b√°n":"Ch·∫ø ƒë·ªô Kh√°ch";
  if(role==="guest") addFormSection.style.display="none";

  onValue(ref(db,"products"),snap=>{
    products=[];
    snap.forEach(c=>products.push({id:c.key,...c.val()}));
    renderProducts();
  });
}

function renderProducts(){
  productList.innerHTML="";
  products.forEach((p,i)=>{
    const col=document.createElement("div");
    col.className="col-6 col-md-4 col-lg-3 col-xl-2";
    col.innerHTML=`
    <div class="card h-100 product-card" style="cursor:pointer">
      <img src="${p.image}" class="card-img-top preview-img">
      <div class="card-body d-flex flex-column">
        <h6>${p.name}</h6>
        <p class="small text-muted">${p.desc}</p>
        <div class="price mb-2">${Number(p.price).toLocaleString()} VND</div>
        ${role==="admin"?`<div class="mt-auto d-flex justify-content-between">
        <button class="btn btn-sm btn-warning edit-btn">S·ª≠a</button>
        <button class="btn btn-sm btn-danger delete-btn">X√≥a</button></div>`:""}
      </div>
    </div>`;

    if(role==="guest") col.querySelector(".product-card").onclick=()=>addToCart(p);
    if(role==="admin"){
      col.querySelector(".delete-btn").onclick=e=>{e.stopPropagation();remove(ref(db,"products/"+p.id));};
      col.querySelector(".edit-btn").onclick=e=>{e.stopPropagation();currentEditIndex=i;editPrice.value=p.price;editModalInstance.show();};
    }
    productList.appendChild(col);
  });
}

function addToCart(p){
  let f=cart.find(i=>i.id===p.id);
  f?f.qty++:cart.push({...p,qty:1});
  alert("ƒê√£ th√™m v√†o gi·ªè üõí");
}

function openCart(){
  cartBody.innerHTML="";
  let total=0;
  cart.forEach(i=>{
    total+=i.price*i.qty;
    cartBody.innerHTML+=`<div class="d-flex justify-content-between border-bottom py-2">
    <div><strong>${i.name}</strong><br>SL: ${i.qty}</div>
    <div class="price">${Number(i.price*i.qty).toLocaleString()} VND</div></div>`;
  });
  cartTotal.textContent=Number(total).toLocaleString()+" VND";
  cartModalInstance.show();
}

function checkoutCart(){
  if(cart.length===0) return alert("Gi·ªè h√†ng tr·ªëng!");
  let total=cart.reduce((s,i)=>s+i.price*i.qty,0);
  billName.textContent="Thanh to√°n gi·ªè h√†ng";
  billDesc.textContent="T·ªïng nhi·ªÅu s·∫£n ph·∫©m";
  billTotal.textContent=Number(total).toLocaleString()+" VND";
  qrImg.src=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ThanhToan_${total}_VND`;
  cartModalInstance.hide();
  billModalInstance.show();
}

saveEdit.onclick=()=>{
  let up={price:editPrice.value};
  update(ref(db,"products/"+products[currentEditIndex].id),up);
  editModalInstance.hide();
};

productForm.onsubmit=e=>{
  e.preventDefault();
  const r=new FileReader();
  r.onload=e2=>{
    push(ref(db,"products"),{
      name:nameInput.value,
      price:priceInput.value,
      desc:descInput.value,
      image:e2.target.result
    });
    productForm.reset();
  };
  r.readAsDataURL(imageInput.files[0]);
};
</script>
</body>
</html>
