<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Mini</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; }
  .card:hover { transform: translateY(-4px); box-shadow:0 4px 15px rgba(0,0,0,.1); transition:.2s; }
  .preview-img { height:150px; object-fit:cover; }
  .price { color:#e53935; font-weight:bold; }
</style>
</head>
<body>

<div class="container mt-4">

  <div id="loginSection" class="card mx-auto" style="max-width:400px;">
    <div class="card-body">
      <h4 class="text-center mb-3">ğŸ” ÄÄƒng nháº­p</h4>
      <input id="username" class="form-control mb-2" placeholder="TÃ i khoáº£n">
      <input id="password" type="password" class="form-control mb-3" placeholder="Máº­t kháº©u">
      <button class="btn btn-primary w-100 mb-2" onclick="login()">ÄÄƒng nháº­p</button>
      <button class="btn btn-secondary w-100" onclick="loginGuest()">VÃ o vá»›i tÆ° cÃ¡ch khÃ¡ch</button>
    </div>
  </div>

  <div id="shopSection" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>ğŸ›’ Shop Mini</h2>
      <div>
        <button id="cartBtn" class="btn btn-success btn-sm me-2" style="display:none">
          ğŸ§¾ Giá» hÃ ng (<span id="cartCount">0</span>)
        </button>

        <button id="myOrdersBtn" class="btn btn-info btn-sm me-2" style="display:none">
          ğŸ“œ ÄÆ¡n cá»§a tÃ´i
        </button>

        <span id="roleLabel" class="me-3 fw-bold text-primary"></span>

        <button id="orderToggleBtn" class="btn btn-warning btn-sm me-2" style="display:none">
          ğŸ“¦ ÄÆ¡n hÃ ng
        </button>

        <button class="btn btn-outline-danger btn-sm" onclick="logout()">ÄÄƒng xuáº¥t</button>
      </div>
    </div>

    <div id="addFormSection" class="card mb-4">
      <div class="card-body">
        <h5>ThÃªm sáº£n pháº©m</h5>
        <form id="productForm">
          <div class="row g-2">
            <div class="col-md-3"><input id="nameInput" class="form-control" placeholder="TÃªn" required></div>
            <div class="col-md-3"><input id="priceInput" type="number" class="form-control" placeholder="GiÃ¡" required></div>
            <div class="col-md-2"><input id="qtyInput" type="number" class="form-control" placeholder="Tá»“n kho" required></div>
            <div class="col-md-4"><input id="descInput" class="form-control" placeholder="MÃ´ táº£" required></div>
            <div class="col-md-2"><input id="imageInput" type="file" class="form-control" accept="image/*" required></div>
          </div>
          <button class="btn btn-success mt-2">ThÃªm</button>
        </form>
      </div>
    </div>

    <div id="orderSection" class="card mb-4" style="display:none;">
      <div class="card-body">
        <h5>ğŸ“¦ ÄÆ¡n hÃ ng khÃ¡ch Ä‘Ã£ Ä‘áº·t</h5>
        <div id="orderList"></div>
      </div>
    </div>

    <div class="row g-3" id="productList"></div>
  </div>
</div>

<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Chá»‰nh sá»­a sáº£n pháº©m</h5></div>
      <div class="modal-body">
        <input id="editName" class="form-control mb-2" placeholder="TÃªn sáº£n pháº©m">
        <input type="number" id="editPrice" class="form-control mb-2" placeholder="GiÃ¡ má»›i">
        <input type="number" id="editQty" class="form-control mb-2" placeholder="Tá»“n kho">
        <input type="file" id="editImage" class="form-control" accept="image/*">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Há»§y</button>
        <button class="btn btn-primary" id="saveEdit">LÆ°u</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="billModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>ğŸ§¾ HÃ³a Ä‘Æ¡n</h5></div>
      <div class="modal-body">
        <h6 id="billName"></h6>
        <p id="billDesc" class="text-muted"></p>

        <label id="qtyLabel">Sá»‘ lÆ°á»£ng</label>
        <input type="number" id="billQty" value="1" min="1" class="form-control mb-3">

        <strong>Tá»•ng tiá»n: <span id="billTotal" class="price"></span></strong>

        <div id="customerInfo" style="display:none;" class="mt-3">
          <input id="customerName" class="form-control mb-2" placeholder="TÃªn ngÆ°á»i nháº­n">
          <input id="customerPhone" class="form-control mb-2" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i">
          <input id="customerAddress" class="form-control" placeholder="Äá»‹a chá»‰ nháº­n hÃ ng">
        </div>

        <div id="qrSection" class="text-center mt-3" style="display:none;">
          <p>QR thanh toÃ¡n</p>
          <img id="qrImg" width="200">
        </div>

        <button id="addToCartBtn" class="btn btn-primary w-100 mt-3">ThÃªm vÃ o giá»</button>
        <button id="confirmOrderBtn" class="btn btn-success w-100 mt-2" style="display:none">âœ… XÃ¡c nháº­n Ä‘áº·t hÃ ng</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myOrdersModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>ğŸ“œ Tra cá»©u Ä‘Æ¡n hÃ ng</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="myOrdersList"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCVURUjjiLytzRcFe9RABka5gysGtQgWs",
  authDomain: "web-ban-hang-21eb3.firebaseapp.com",
  projectId: "web-ban-hang-21eb3",
  storageBucket: "web-ban-hang-21eb3.firebasestorage.app",
  messagingSenderId: "661863406472",
  appId: "1:661863406472:web:eb22711a8fcff4d411f83d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role = null;
let products = [];
let currentEditIndex = null;
let currentBillProduct = null;
let cart = [];

const editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
const billModalInstance = new bootstrap.Modal(document.getElementById('billModal'));
const myOrdersModal = new bootstrap.Modal(document.getElementById('myOrdersModal'));

window.login = function(){
  if(username.value==="admin" && password.value==="123"){
    role="admin"; startShop();
  } else alert("Sai tÃ i khoáº£n!");
}
window.loginGuest = function(){ role="guest"; startShop(); }
window.logout = function(){ location.reload(); }

function startShop(){
  loginSection.style.display="none";
  shopSection.style.display="block";
  roleLabel.textContent = role==="admin" ? "Cháº¿ Ä‘á»™ NgÆ°á»i bÃ¡n" : "Cháº¿ Ä‘á»™ KhÃ¡ch";
  if(role==="guest"){
    addFormSection.style.display="none";
    myOrdersBtn.style.display="inline-block";
    myOrdersBtn.onclick = showMyOrders;
  }

  if(role==="admin"){
    orderToggleBtn.style.display="inline-block";
    orderToggleBtn.onclick=()=>orderSection.style.display=
      orderSection.style.display==="none"?"block":"none";

    onValue(ref(db,"orders"), snapshot=> renderOrders(snapshot));
  }

  onValue(ref(db,"products"), snapshot=>{
    products=[];
    snapshot.forEach(child=>{
      products.push({id:child.key, ...child.val()});
    });
    renderProducts();
  });
}

function renderProducts(){
  productList.innerHTML="";
  products.forEach((p,i)=>{
    const col=document.createElement("div");
    col.className="col-6 col-md-4 col-lg-3 col-xl-2";
    col.innerHTML=`
      <div class="card h-100 product-card" style="cursor:pointer">
        <img src="${p.image}" class="card-img-top preview-img">
        <div class="card-body d-flex flex-column">
          <h6>${p.name}</h6>
          <p class="small text-muted">${p.desc}</p>
          <div class="price mb-2">${Number(p.price).toLocaleString()} VND</div>
          ${role==="admin"?`<div class="text-muted small">Kho: ${p.quantity || 0}</div>`:""}
          ${role==="admin"?`
          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-warning edit-btn">Sá»­a</button>
            <button class="btn btn-sm btn-danger delete-btn">XÃ³a</button>
          </div>`:""}
        </div>
      </div>`;

    if(role==="guest"){
      col.querySelector(".product-card").addEventListener("click", ()=> openBill(p));
    }

    if(role==="admin"){
      col.querySelector(".delete-btn").onclick=(e)=>{
        e.stopPropagation();
        remove(ref(db,"products/"+p.id));
      };
      col.querySelector(".edit-btn").onclick=(e)=>{
        e.stopPropagation();
        currentEditIndex=i;
        editName.value = p.name;
        editPrice.value = p.price;
        editQty.value = p.quantity || 0;
        editImage.value="";
        editModalInstance.show();
      };
    }

    productList.appendChild(col);
  });
}

function renderOrders(snapshot){
  orderList.innerHTML="";
  snapshot.forEach(child=>{
    const order = child.val();
    const orderId = child.key;

    const div = document.createElement("div");
    div.className = "border p-2 mb-2 rounded small";
    div.innerHTML = `
      <strong>ğŸ§¾ ÄÆ¡n lÃºc:</strong> ${order.time} <br>
      <strong>ğŸ‘¤ KhÃ¡ch:</strong> ${order.customerName || "KhÃ´ng cÃ³"} <br>
      <strong>ğŸ“ SÄT:</strong> ${order.customerPhone || "KhÃ´ng cÃ³"} <br>
      <strong>ğŸ  Äá»‹a chá»‰:</strong> ${order.customerAddress || "KhÃ´ng cÃ³"} <br>
      <pre class="mb-1">${order.items.map(i=>`${i.name} x${i.qty}`).join("\n")}</pre>
      <strong>Tá»•ng tiá»n:</strong> ${Number(order.total).toLocaleString()} VND<br>
      <label>
        <input type="checkbox" ${order.seen ? "checked" : ""}>
        ÄÃ£ xá»­ lÃ½
      </label>
      <button class="btn btn-sm btn-danger mt-2 delete-order-btn">ğŸ—‘ XÃ³a Ä‘Æ¡n</button>
    `;

    div.querySelector("input").onchange = (e) => {
      update(ref(db,"orders/"+orderId), { seen: e.target.checked });
    };

    div.querySelector(".delete-order-btn").onclick = () => {
      if(confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y khÃ´ng?")){
        remove(ref(db,"orders/"+orderId));
      }
    };

    orderList.appendChild(div);
  });
}

function openBill(p){
  currentBillProduct=p;
  billName.textContent=p.name;
  billDesc.textContent=p.desc;
  billQty.style.display="block";
  qtyLabel.style.display="block";
  addToCartBtn.style.display="block";
  confirmOrderBtn.style.display="none";
  customerInfo.style.display="none";
  qrSection.style.display="none";
  billQty.value=1;
  updateTotal();
  billModalInstance.show();
}

function updateTotal(){
  let total=currentBillProduct.price*billQty.value;
  billTotal.textContent=Number(total).toLocaleString()+" VND";
}
billQty.addEventListener("input",updateTotal);

addToCartBtn.onclick = function(){
  const qty = parseInt(billQty.value);
  if(!qty || qty < 1) return;
  if(qty > (currentBillProduct.quantity || 0)){
    alert("KhÃ´ng Ä‘á»§ hÃ ng trong kho!");
    return;
  }
  const found = cart.find(item => item.id === currentBillProduct.id);
  if(found){ found.qty += qty; }
  else{ cart.push({...currentBillProduct, qty: qty}); }
  updateCartUI();
  billModalInstance.hide();
};

function updateCartUI(){
  cartBtn.style.display = cart.length ? "inline-block" : "none";
  cartCount.textContent = cart.reduce((t,i)=>t+i.qty,0);
}

cartBtn.onclick = function(){
  billName.textContent = "XÃ¡c nháº­n Ä‘Æ¡n hÃ ng";
  billDesc.textContent = cart.map(i=>`${i.name} x${i.qty}`).join("\n");
  billQty.style.display="none";
  qtyLabel.style.display="none";
  addToCartBtn.style.display="none";
  customerInfo.style.display="block";
  confirmOrderBtn.style.display="block";
  qrSection.style.display="none";
  billModalInstance.show();
};

confirmOrderBtn.onclick = async function(){
  const name = customerName.value.trim();
  const phone = customerPhone.value.trim();
  const address = customerAddress.value.trim();
  if(!name || !phone || !address) return alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");

  let total = 0;
  for(const item of cart){
    const snap = await get(ref(db,"products/"+item.id));
    const latest = snap.val();
    if(item.qty > latest.quantity) return alert(`Sáº£n pháº©m ${item.name} khÃ´ng Ä‘á»§ tá»“n kho!`);
  }
  for(const item of cart){
    total += item.price * item.qty;
    const snap = await get(ref(db,"products/"+item.id));
    const latest = snap.val();
    await update(ref(db,"products/"+item.id),{ quantity: latest.quantity - item.qty });
  }

  await push(ref(db,"orders"),{
    items: cart,
    total: total,
    time: new Date().toLocaleString(),
    seen: false,
    customerName: name,
    customerPhone: phone,
    customerAddress: address
  });

  billName.textContent="HÃ³a Ä‘Æ¡n";
  billDesc.textContent=cart.map(i=>`${i.name} x${i.qty}`).join("\n");
  billTotal.textContent=Number(total).toLocaleString()+" VND";
  customerInfo.style.display="none";
  confirmOrderBtn.style.display="none";
  qrSection.style.display="block";
  qrImg.src=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ThanhToan_${total}_VND`;

  cart=[];
  updateCartUI();
};

function showMyOrders(){
  myOrdersList.innerHTML = `
    <input id="searchPhone" class="form-control mb-2" placeholder="Nháº­p SÄT Ä‘Ã£ Ä‘áº·t hÃ ng">
    <button class="btn btn-primary w-100" onclick="searchMyOrders()">ğŸ” TÃ¬m Ä‘Æ¡n</button>
    <div id="orderSearchResult" class="mt-3 small"></div>
  `;
  myOrdersModal.show();
}

window.searchMyOrders = function(){
  const phone = document.getElementById("searchPhone").value.trim();
  const box = document.getElementById("orderSearchResult");

  if(!phone){
    box.innerHTML = "<p class='text-danger'>Vui lÃ²ng nháº­p SÄT!</p>";
    return;
  }

  box.innerHTML = "Äang tÃ¬m Ä‘Æ¡n hÃ ng...";

  get(ref(db,"orders")).then(snapshot=>{
    box.innerHTML="";
    let found=false;

    snapshot.forEach(child=>{
      const o=child.val();
      const orderId = child.key;

      if(o.customerPhone && o.customerPhone===phone){
        found=true;
        box.innerHTML+=`
          <div class="border rounded p-2 mb-2">
            <strong>ğŸ•’ ${o.time}</strong><br>
            ${o.items.map(i=>`${i.name} x${i.qty}`).join("<br>")}
            <br><strong>Tá»•ng tiá»n:</strong> ${Number(o.total).toLocaleString()} VND
            <br>
            <span class="badge ${o.seen?"bg-success":"bg-warning"}">
              ${o.seen?"ÄÃ£ xá»­ lÃ½":"Chá» xá»­ lÃ½"}
            </span>
            ${!o.seen ? `<button class="btn btn-sm btn-danger mt-2" onclick="cancelOrder('${orderId}')">âŒ Há»§y Ä‘Æ¡n</button>` : ``}
          </div>
        `;
      }
    });

    if(!found) box.innerHTML="<p class='text-muted'>KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o.</p>";
  });
};

async function restoreStock(items){
  for(const item of items){
    const snap = await get(ref(db,"products/"+item.id));
    if(!snap.exists()) continue;
    const p = snap.val();
    await update(ref(db,"products/"+item.id),{
      quantity: (p.quantity || 0) + item.qty
    });
  }
}

window.cancelOrder = async function(orderId){
  if(!confirm("Báº¡n cÃ³ cháº¯c muá»‘n há»§y Ä‘Æ¡n nÃ y khÃ´ng?")) return;

  const snap = await get(ref(db,"orders/"+orderId));
  if(!snap.exists()) return;

  const order = snap.val();

  if(order.seen){
    alert("ÄÆ¡n Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½, khÃ´ng thá»ƒ há»§y!");
    return;
  }

  await restoreStock(order.items);
  await remove(ref(db,"orders/"+orderId));
  alert("ÄÃ£ há»§y Ä‘Æ¡n vÃ  hoÃ n láº¡i tá»“n kho!");
  searchMyOrders();
};

saveEdit.onclick = () => {
  let updates = {};
  if(editName.value) updates.name = editName.value;
  if(editPrice.value) updates.price = parseInt(editPrice.value);
  if(editQty.value) updates.quantity = parseInt(editQty.value);
  if(editImage.files[0]){
    const r = new FileReader();
    r.onload = e => {
      updates.image = e.target.result;
      update(ref(db,"products/"+products[currentEditIndex].id), updates);
    };
    r.readAsDataURL(editImage.files[0]);
  } else {
    update(ref(db,"products/"+products[currentEditIndex].id), updates);
  }
  editModalInstance.hide();
};

productForm.onsubmit=e=>{
  e.preventDefault();
  const r=new FileReader();
  r.onload=e2=>{
    push(ref(db,"products"),{
      name:nameInput.value,
      price:priceInput.value,
      quantity: parseInt(qtyInput.value),
      desc:descInput.value,
      image:e2.target.result
    });
    productForm.reset();
  };
  r.readAsDataURL(imageInput.files[0]);
};
</script>
</body>
</html>
