<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Mini</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; }
  .card:hover { transform: translateY(-4px); box-shadow:0 4px 15px rgba(0,0,0,.1); transition:.2s; }
  .preview-img { height:150px; object-fit:cover; }
  .price { color:#e53935; font-weight:bold; }
</style>
</head>
<body>

<div class="container mt-4">

  <div id="loginSection" class="card mx-auto" style="max-width:400px;">
    <div class="card-body">
      <h4 class="text-center mb-3">üîê ƒêƒÉng nh·∫≠p</h4>
      <input id="username" class="form-control mb-2" placeholder="T√†i kho·∫£n">
      <input id="password" type="password" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u">
      <button class="btn btn-primary w-100 mb-2" onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <button class="btn btn-secondary w-100" onclick="loginGuest()">V√†o v·ªõi t∆∞ c√°ch kh√°ch</button>
    </div>
  </div>

  <div id="shopSection" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üõí Shop Mini</h2>
      <div>
        <button id="cartBtn" class="btn btn-success btn-sm me-2" style="display:none">
          üßæ Gi·ªè h√†ng (<span id="cartCount">0</span>)
        </button>
        <span id="roleLabel" class="me-3 fw-bold text-primary"></span>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div id="addFormSection" class="card mb-4">
      <div class="card-body">
        <h5>Th√™m s·∫£n ph·∫©m</h5>
        <form id="productForm">
          <div class="row g-2">
            <div class="col-md-3"><input id="nameInput" class="form-control" placeholder="T√™n" required></div>
            <div class="col-md-3"><input id="priceInput" type="number" class="form-control" placeholder="Gi√°" required></div>
            <div class="col-md-2"><input id="qtyInput" type="number" class="form-control" placeholder="T·ªìn kho" required></div>
            <div class="col-md-4"><input id="descInput" class="form-control" placeholder="M√¥ t·∫£" required></div>
            <div class="col-md-2"><input id="imageInput" type="file" class="form-control" accept="image/*" required></div>
          </div>
          <button class="btn btn-success mt-2">Th√™m</button>
        </form>
      </div>
    </div>

    <div class="row g-3" id="productList"></div>
  </div>
</div>

<!-- Modal s·ª≠a -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h5></div>
      <div class="modal-body">
         <input id="editName" class="form-control mb-2" placeholder="T√™n s·∫£n ph·∫©m">
        <input type="number" id="editPrice" class="form-control mb-2" placeholder="Gi√° m·ªõi">
        <input type="number" id="editQty" class="form-control mb-2" placeholder="T·ªìn kho">
        <input type="file" id="editImage" class="form-control" accept="image/*">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-primary" id="saveEdit">L∆∞u</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal h√≥a ƒë∆°n -->
<div class="modal fade" id="billModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>üßæ H√≥a ƒë∆°n</h5></div>
      <div class="modal-body">
        <h6 id="billName"></h6>
        <p id="billDesc" class="text-muted"></p>

        <label id="qtyLabel">S·ªë l∆∞·ª£ng</label>
        <input type="number" id="billQty" value="1" min="1" class="form-control mb-3">

        <strong>T·ªïng ti·ªÅn: <span id="billTotal" class="price"></span></strong>

        <div id="qrSection" class="text-center mt-3" style="display:none;">
          <p>QR thanh to√°n</p>
          <img id="qrImg" width="200">
        </div>

        <button id="addToCartBtn" class="btn btn-primary w-100 mt-3">Th√™m v√†o gi·ªè</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCVURUjjiLytzRcFe9RABka5gysGtQgWs",
  authDomain: "web-ban-hang-21eb3.firebaseapp.com",
  projectId: "web-ban-hang-21eb3",
  storageBucket: "web-ban-hang-21eb3.firebasestorage.app",
  messagingSenderId: "661863406472",
  appId: "1:661863406472:web:eb22711a8fcff4d411f83d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role = null;
let products = [];
let currentEditIndex = null;
let currentBillProduct = null;
let cart = [];

const editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
const billModalInstance = new bootstrap.Modal(document.getElementById('billModal'));

window.login = function(){
  if(username.value==="admin" && password.value==="123"){
    role="admin"; startShop();
  } else alert("Sai t√†i kho·∫£n!");
}
window.loginGuest = function(){ role="guest"; startShop(); }
window.logout = function(){ location.reload(); }

function startShop(){
  loginSection.style.display="none";
  shopSection.style.display="block";
  roleLabel.textContent = role==="admin" ? "Ch·∫ø ƒë·ªô Ng∆∞·ªùi b√°n" : "Ch·∫ø ƒë·ªô Kh√°ch";
  if(role==="guest") addFormSection.style.display="none";

  if(role==="admin"){
    onValue(ref(db,"orders"), snapshot=>{
      if(snapshot.exists()) alert("üîî C√≥ ƒë∆°n h√†ng m·ªõi!");
    });
  }

  onValue(ref(db,"products"), snapshot=>{
    products=[];
    snapshot.forEach(child=>{
      products.push({id:child.key, ...child.val()});
    });
    renderProducts();
  });
}

function renderProducts(){
  productList.innerHTML="";
  products.forEach((p,i)=>{
    const col=document.createElement("div");
    col.className="col-6 col-md-4 col-lg-3 col-xl-2";
    col.innerHTML=`
      <div class="card h-100 product-card" style="cursor:pointer">
        <img src="${p.image}" class="card-img-top preview-img">
        <div class="card-body d-flex flex-column">
          <h6>${p.name}</h6>
          <p class="small text-muted">${p.desc}</p>
          <div class="price mb-2">${Number(p.price).toLocaleString()} VND</div>
          ${role==="admin"?`<div class="text-muted small">Kho: ${p.quantity || 0}</div>`:""}
          ${role==="admin"?`
          <div class="mt-auto d-flex justify-content-between">
            <button class="btn btn-sm btn-warning edit-btn">S·ª≠a</button>
            <button class="btn btn-sm btn-danger delete-btn">X√≥a</button>
          </div>`:""}
        </div>
      </div>`;

    if(role==="guest"){
      col.querySelector(".product-card").addEventListener("click", ()=> openBill(p));
    }

    if(role==="admin"){
      col.querySelector(".delete-btn").onclick=(e)=>{
        e.stopPropagation();
        remove(ref(db,"products/"+p.id));
      };
      col.querySelector(".edit-btn").onclick=(e)=>{
        e.stopPropagation();
        currentEditIndex=i;
        editName.value = p.name;
        editPrice.value = p.price;
        editQty.value = p.quantity || 0;
        editImage.value="";
        editModalInstance.show();
      };
    }

    productList.appendChild(col);
  });
}

function openBill(p){
  currentBillProduct=p;
  billName.textContent=p.name;
  billDesc.textContent=p.desc;
  billQty.style.display="block";
  qtyLabel.style.display="block";
  addToCartBtn.style.display="block";
  qrSection.style.display="none";
  billQty.value=1;
  updateTotal();
  billModalInstance.show();
}

function updateTotal(){
  let total=currentBillProduct.price*billQty.value;
  billTotal.textContent=Number(total).toLocaleString()+" VND";
}
billQty.addEventListener("input",updateTotal);

addToCartBtn.onclick = function(){
  const qty = parseInt(billQty.value);
  if(!qty || qty < 1) return;
  if(qty > (currentBillProduct.quantity || 0)){
    alert("Kh√¥ng ƒë·ªß h√†ng trong kho!");
    return;
  }

  const found = cart.find(item => item.id === currentBillProduct.id);
  if(found){ found.qty += qty; }
  else{ cart.push({...currentBillProduct, qty: qty}); }

  updateCartUI();
  billModalInstance.hide();
};

function updateCartUI(){
  cartBtn.style.display = cart.length ? "inline-block" : "none";
  cartCount.textContent = cart.reduce((t,i)=>t+i.qty,0);
}

cartBtn.onclick = async function(){
  if(cart.length===0) return;

  let total = 0;
  let descText = "";

  for(const item of cart){
    const snap = await get(ref(db,"products/"+item.id));
    const latest = snap.val();
    if(item.qty > latest.quantity){
      alert(`S·∫£n ph·∫©m ${item.name} kh√¥ng ƒë·ªß t·ªìn kho!`);
      return;
    }
  }

  for(const item of cart){
    total += item.price * item.qty;
    descText += `${item.name} x${item.qty}\n`;

    const snap = await get(ref(db,"products/"+item.id));
    const latest = snap.val();
    await update(ref(db,"products/"+item.id),{
      quantity: latest.quantity - item.qty
    });
  }

  await push(ref(db,"orders"),{
    items: cart,
    total: total,
    time: new Date().toLocaleString()
  });

  billName.textContent = "H√≥a ƒë∆°n t·ªïng";
  billDesc.textContent = descText;
  billQty.style.display = "none";
  qtyLabel.style.display = "none";
  addToCartBtn.style.display = "none";

  qrSection.style.display="block";
  billTotal.textContent = Number(total).toLocaleString()+" VND";
  qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ThanhToan_${total}_VND`;

  billModalInstance.show();
  cart = [];
  updateCartUI();
};

saveEdit.onclick = () => {
  let updates = {};

  if(editName.value) updates.name = editName.value;
  if(editPrice.value) updates.price = parseInt(editPrice.value);
  if(editQty.value) updates.quantity = parseInt(editQty.value);

  if(editImage.files[0]){
    const r = new FileReader();
    r.onload = e => {
      updates.image = e.target.result;
      update(ref(db,"products/"+products[currentEditIndex].id), updates);
    };
    r.readAsDataURL(editImage.files[0]);
  } else {
    update(ref(db,"products/"+products[currentEditIndex].id), updates);
  }

  editModalInstance.hide();
};


productForm.onsubmit=e=>{
  e.preventDefault();
  const r=new FileReader();
  r.onload=e2=>{
    push(ref(db,"products"),{
      name:nameInput.value,
      price:priceInput.value,
      quantity: parseInt(qtyInput.value),
      desc:descInput.value,
      image:e2.target.result
    });
    productForm.reset();
  };
  r.readAsDataURL(imageInput.files[0]);
};
</script>
</body>
</html>


